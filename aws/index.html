<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Miguel Amorós">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>AWS - Miguel's Notes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "AWS";
    var mkdocs_page_input_path = "aws.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Miguel's Notes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">MkDocs</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../linux/">Linux</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../soporte/">Soporte TI</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../vscode/">VSCode</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../gitlab/">Gitlab</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../python/">Python</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../bash_scripting/">BashScripting</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../powershell/">PowerShell/CMD</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../virtuales/">M.Virtuales</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../docker/">Docker</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../kubernetes/">Kubernetes</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../openshift/">Openshift</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../terraform/">Terraform</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">AWS</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#iac-cloudformation">IAC CLOUDFORMATION</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-stack">Create STACK</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#parametros">Parámetros</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#recursos">Recursos</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#mapping">Mapping</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#outputs">Outputs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#conditions">Conditions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#functions">Functions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#user-data">User data</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cfn-init">Cfn-init</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cfn-signal">Cfn-signal</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rollback">Rollback</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cfn-nested-stacks">Cfn nested stacks</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#change-sets">Change sets</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#depends-on">Depends on</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#detect-drift-stack">Detect drift stack</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../jenkins/">Jenkins</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ansible/">Ansible</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tomcat/">Tomcat</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../elastic/">ELKS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../azure/">Azure</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../office/">Office 365</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../markdown/">Markdown</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../bbdd/">Base de datos</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../sap/">SAP</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ldap/">LDAP</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../pam/">PAM</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../samba/">SAMBA</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../kerberos/">KERBEROS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../lvm/">LVM/RAID</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../routing/">Routing</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../files/">Archivos Destacados</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../windows/">Windows</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../taller/">Taller</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Miguel's Notes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>AWS</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/isx46410800/miguelamoros.github.io/edit/master/docs/aws.md"> Edit on isx46410800/python</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="aws">AWS</h1>
<h2 id="iac-cloudformation">IAC CLOUDFORMATION</h2>
<ul>
<li>
<p>IAC (Infrastructure as Code)</p>
</li>
<li>
<p>AWS CloudFormation le ofrece una forma sencilla de modelar un conjunto de recursos relacionados de AWS y de terceros, aprovisionarlos de manera rápida y consistente y administrarlos a lo largo de sus ciclos de vida tratando la infraestructura como un código. La plantilla de CloudFormation describe los recursos que desea y sus dependencias para que los pueda lanzar y configurar juntos como una pila. Puede usar la plantilla para crear, actualizar y eliminar toda una pila como una única unidad, tantas veces como lo necesite, en lugar de administrar los recursos de manera individual. Puede administrar y aprovisionar pilas en varias cuentas y regiones de AWS.</p>
</li>
<li>
<p>web (https://aws.amazon.com/es/cloudformation/)</p>
</li>
<li>
<p>Documentación (https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html)</p>
</li>
<li>
<p>Sintaxis simple:  </p>
</li>
</ul>
<pre><code>---
Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
            AvailabilityZone: us-east-1a
            ImageId: ami-123456789
            InstanceType: t2.micro
</code></pre>

<ul>
<li>Sintaxis compleja:  </li>
</ul>
<pre><code>---
Parameters:
    SecurityGroupDescription:
        Description: Security-Group Description
        Type: String

Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
            AvailabilityZone: us-east-1a
            ImageId: ami-123456789
            InstanceType: t2.micro
            SecurityGroups:
                - !Ref SSHSecurityGroup
                - !Ref ServerSecurityGroup

    # an elastic Ip for our instance
    MyEIP:
        Type: AWS::EC2::EIP
        Properties:
            InstanceId: !Ref MyInstance

    # our EC2 security group
    SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Enable port 22
            SecurityGroupIngress:
            - CidrIp: 0.0.0.0/0
              FromPort: 22
              IpProtocol: tcp
              ToPort: 22

    # our second EC2 security group
    SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: !Red SecurityGroupDescription
            SecurityGroupIngress:
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: 0.0.0.0/0
            - IpProtocol: tcp
              FromPort: 22
              ToPort: 22
              CidrIp: 10.10.0.1/32
</code></pre>

<h3 id="create-stack">Create STACK</h3>
<ul>
<li>Vamos a consola , cloudformation, crear stack, crear template, subir fichero y ponemos nuestra instancia simple de código en el fichero y veremos como crea una instancia del tipo que se le indica:  </li>
</ul>
<pre><code>---
Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
            AvailabilityZone: us-east-1a
            ImageId: ami-123456789
            InstanceType: t2.micro
</code></pre>

<ul>
<li>Para actualizar la que tenemos vamos a crear stack, replace current template, subimos fichero y veremos en los eventos como se actualiza:  </li>
</ul>
<pre><code>---
Parameters:
    SecurityGroupDescription:
        Description: Security-Group Description
        Type: String

Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
            AvailabilityZone: us-east-1a
            ImageId: ami-123456789
            InstanceType: t2.micro
            SecurityGroups:
                - !Ref SSHSecurityGroup
                - !Ref ServerSecurityGroup

    # an elastic Ip for our instance
    MyEIP:
        Type: AWS::EC2::EIP
        Properties:
            InstanceId: !Ref MyInstance

    # our EC2 security group
    SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Enable port 22
            SecurityGroupIngress:
            - CidrIp: 0.0.0.0/0
              FromPort: 22
              IpProtocol: tcp
              ToPort: 22

    # our second EC2 security group
    SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: !Red SecurityGroupDescription
            SecurityGroupIngress:
            - IpProtocol: tcp
              FromPort: 80
              ToPort: 80
              CidrIp: 0.0.0.0/0
            - IpProtocol: tcp
              FromPort: 22
              ToPort: 22
              CidrIp: 10.10.0.1/32
</code></pre>

<blockquote>
<p>Despues se puede borrar con Delete en los eventos.  </p>
</blockquote>
<h3 id="parametros">Parámetros</h3>
<ul>
<li>
<p>Podemos indicar una serie de <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html">parametros</a> a la hora de crear nuestra IAC:  </p>
</li>
<li>
<p>Ejemplo 1:  </p>
</li>
</ul>
<pre><code>Parameters:
  InstanceTypeParameter:
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - m1.small
      - m1.large
    Description: Enter t2.micro, m1.small, or m1.large. Default is t2.micro.
</code></pre>

<ul>
<li>Ejemplo2:  </li>
</ul>
<pre><code>Parameters: 
  DBPort: 
    Default: 3306
    Description: TCP/IP port for the database
    Type: Number
    MinValue: 1150
    MaxValue: 65535
  DBPwd: 
    NoEcho: true
    Description: The database admin account password
    Type: String
    MinLength: 1
    MaxLength: 41
    AllowedPattern: ^[a-zA-Z0-9]*$
</code></pre>

<h3 id="recursos">Recursos</h3>
<ul>
<li>
<p>En esta sección declaramos qué <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html#resources-section-structure-examples">recursos</a> queremos crear en nuestro stack</p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>Resources: 
  MyInstance: 
    Type: &quot;AWS::EC2::Instance&quot;
    Properties: 
      UserData: 
        &quot;Fn::Base64&quot;:
          !Sub |
            Queue=${MyQueue}
      AvailabilityZone: &quot;us-east-1a&quot;
      ImageId: &quot;ami-0ff8a91507f77f867&quot;
  MyQueue: 
    Type: &quot;AWS::SQS::Queue&quot;
    Properties: {}
</code></pre>

<ul>
<li>
<p>Todos los tipos de <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/AWS_EC2.html">recursos</a> </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>Type: AWS::EC2::Instance
Properties: 
  AdditionalInfo: String
  Affinity: String
  AvailabilityZone: String
  BlockDeviceMappings: 
    - BlockDeviceMapping
  CpuOptions: 
    CpuOptions
  CreditSpecification: 
    CreditSpecification
  DisableApiTermination: Boolean
  EbsOptimized: Boolean
  ElasticGpuSpecifications: 
    - ElasticGpuSpecification
  ElasticInferenceAccelerators: 
    - ElasticInferenceAccelerator
  EnclaveOptions: 
    EnclaveOptions
  HibernationOptions: 
    HibernationOptions
  HostId: String
  HostResourceGroupArn: String
  IamInstanceProfile: String
  ImageId: String
  InstanceInitiatedShutdownBehavior: String
  InstanceType: String
  Ipv6AddressCount: Integer
  Ipv6Addresses: 
    - InstanceIpv6Address
  KernelId: String
  KeyName: String
  LaunchTemplate: 
    LaunchTemplateSpecification
  LicenseSpecifications: 
    - LicenseSpecification
  Monitoring: Boolean
  NetworkInterfaces: 
    - NetworkInterface
  PlacementGroupName: String
  PrivateIpAddress: String
  RamdiskId: String
  SecurityGroupIds: 
    - String
  SecurityGroups: 
    - String
  SourceDestCheck: Boolean
  SsmAssociations: 
    - SsmAssociation
  SubnetId: String
  Tags: 
    - Tag
  Tenancy: String
  UserData: String
  Volumes: 
    - Volume
</code></pre>

<h3 id="mapping">Mapping</h3>
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/mappings-section-structure.html">Mapea</a> asignando una clave a un valor  </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>AWSTemplateFormatVersion: &quot;2010-09-09&quot;
Mappings: 
  RegionMap: 
    us-east-1:
      HVM64: ami-0ff8a91507f77f867
      HVMG2: ami-0a584ac55a7631c0c
    us-west-1:
      HVM64: ami-0bdb828fd58c52235
      HVMG2: ami-066ee5fd4a9ef77f1
    eu-west-1:
      HVM64: ami-047bb4163c506cd98
      HVMG2: ami-0a7c483d527806435
    ap-northeast-1:
      HVM64: ami-06cd52961ce9f0d85
      HVMG2: ami-053cdd503598e4a9d
    ap-southeast-1:
      HVM64: ami-08569b978cc4dfa10
      HVMG2: ami-0be9df32ae9f92309
Resources: 
  myEC2Instance: 
    Type: &quot;AWS::EC2::Instance&quot;
    Properties: 
      ImageId: !FindInMap [RegionMap, !Ref &quot;AWS::Region&quot;, HVM64]
      InstanceType: m1.small
</code></pre>

<h3 id="outputs">Outputs</h3>
<ul>
<li>
<p>Los <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">outputs</a> nos salidas de mensajes. Intentar no poner información sensible.  </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>Outputs:
  BackupLoadBalancerDNSName:
    Description: The DNSName of the backup load balancer
    Value: !GetAtt BackupLoadBalancer.DNSName
    Condition: CreateProdResources
  InstanceID:
    Description: The Instance ID
    Value: !Ref EC2Instance
</code></pre>

<pre><code>Outputs:
  BackupLoadBalancerDNSName:
    Description: The DNSName of the backup load balancer
    Value: !GetAtt BackupLoadBalancer.DNSName
    Condition: CreateProdResources
  InstanceID:
    Description: The Instance ID
    Value: !Ref EC2Instance
</code></pre>

<h3 id="conditions">Conditions</h3>
<ul>
<li>
<p>Los <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/conditions-section-structure.html">conditions</a> nos indican que hace algo si se cumple tal condición.  </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>AWSTemplateFormatVersion: 2010-09-09
Parameters:
  EnvType:
    Description: Environment type.
    Default: test
    Type: String
    AllowedValues:
      - prod
      - test
    ConstraintDescription: must specify prod or test.
Conditions:
  CreateProdResources: !Equals 
    - !Ref EnvType
    - prod
Resources:
  EC2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: ami-0ff8a91507f77f867
  MountPoint:
    Type: 'AWS::EC2::VolumeAttachment'
    Condition: CreateProdResources
    Properties:
      InstanceId: !Ref EC2Instance
      VolumeId: !Ref NewVolume
      Device: /dev/sdh
  NewVolume:
    Type: 'AWS::EC2::Volume'
    Condition: CreateProdResources
    Properties:
      Size: 100
      AvailabilityZone: !GetAtt 
        - EC2Instance
        - AvailabilityZone
</code></pre>

<h3 id="functions">Functions</h3>
<ul>
<li>Hay diferentes <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference.html">funciones</a> internas en la creación de un template IAC </li>
</ul>
<h3 id="user-data">User data</h3>
<ul>
<li>
<p>Podemos crear plantillas escribiendo ordenes de linux con <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html">user data</a>  </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>---
Parameters:
    SSHKey:
        Description: Name of an existing EC2 keypair to enable ssh access to the instance
        Type: AWS::EC2::KeyPair::KeyName

Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
            AvailabilityZone: us-east-1a
            ImageId: ami-009d6802948d06e52
            InstanceType: t2.micro
            KeyName: !Ref SSHKey
            SecurityGroups:
                - !Ref SSHSecurityGroup
            UserData:
              Fn::Base64: |
                #!/bin/bash -xe
                yum update -y
                yum install -y httpd
                systemctl start httpd
                systemctl enable httpd
                echo &quot;Hello World from user data&quot; &gt; /var/www/html/index.html

    # our EC2 security group
    SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Enable port 22
            SecurityGroupIngress:
            - CidrIp: 0.0.0.0/0
              FromPort: 22
              IpProtocol: tcp
              ToPort: 22
            - CidrIp: 0.0.0.0/0
              FromPort: 80
              IpProtocol: tcp
              ToPort: 80
</code></pre>

<blockquote>
<p>Creamos una stack con el template, ponemos el parametro creado y vemos que sea crea tanto por la ip:80 como por consola.  </p>
</blockquote>
<h3 id="cfn-init">Cfn-init</h3>
<ul>
<li>
<p>Vemos la docu de <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-init.html">cfn init</a> </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>---
Parameters:
    SSHKey:
        Description: Name of an existing EC2 keypair to enable ssh access to the instance
        Type: AWS::EC2::KeyPair::KeyName

Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
            AvailabilityZone: us-east-1a
            ImageId: ami-009d6802948d06e52
            InstanceType: t2.micro
            KeyName: !Ref SSHKey
            SecurityGroups:
                - !Ref SSHSecurityGroup
            UserData:
              Fn::Base64:
                !Sub |
                  #!/bin/bash -xe
                  # get the latest cloudformation package
                  yum update -y aws-cfn-bootstrap
                  # start cfn-init
                  /opt/aws/bin/cfn-init -s ${AWS::StackId} -r MyInstance --region ${AWS::Region} || error_exit &quot;Failed to run cfn-init&quot;
    Metadata:
      Comment: Install a simple Apache HTTP page
      AWS::CloudFormation::Init:
        config:
          package:
            yum:
              httpd:[]
          files:
            &quot;/var/www/html/index.html&quot;
              content: |
                &lt;h1&gt;Hello word, using cfn-init&lt;/h1&gt;
              mode: '000644'
          commands:
            hello:
              command: &quot;echo 'hello world'&quot;
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'

    # our EC2 security group
    SSHSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupDescription: Enable port 22
            SecurityGroupIngress:
            - CidrIp: 0.0.0.0/0
              FromPort: 22
              IpProtocol: tcp
              ToPort: 22
            - CidrIp: 0.0.0.0/0
              FromPort: 80
              IpProtocol: tcp
              ToPort: 80
</code></pre>

<h3 id="cfn-signal">Cfn-signal</h3>
<ul>
<li>
<p>Docu de <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-signal.html">cfn-signal</a></p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>AWSTemplateFormatVersion: 2010-09-09
Description: Simple EC2 instance
Resources:
  MyInstance:
    Type: AWS::EC2::Instance
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          files:
            /tmp/test.txt:
              content: Hello world!
              mode: '000755'
              owner: root
              group: root
    Properties:
      ImageId: ami-a4c7edb2
      InstanceType: t2.micro
      UserData: !Base64
        'Fn::Join':
          - ''
          - - |
              #!/bin/bash -x
            - |
              # Install the files and packages from the metadata
            - '/opt/aws/bin/cfn-init -v '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource MyInstance '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

            - |
              # Signal the status from cfn-init
            - '/opt/aws/bin/cfn-signal -e $? '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource MyInstance '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
</code></pre>

<h3 id="rollback">Rollback</h3>
<ul>
<li>Cuando creamos una stack podemos indicar si queremos un rollback para poder volver a un estado anterior.  </li>
</ul>
<h3 id="cfn-nested-stacks">Cfn nested stacks</h3>
<ul>
<li>
<p>Docu de stack anidadas entre sí<a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-nested-stacks.html">cfn nested</a></p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>---
Parameters:
    SSHKey:
        Description: Name of an existing EC2 keypair to enable ssh access to the instance
        Type: AWS::EC2::KeyPair::KeyName

Resources:
    MyInstance:
        Type: AWS::EC2::Instance
        Properties:
          TemplateURL: https://s3.amazonaws.com/cloudformation-templates-us-east-1/LAMP_Single-Instance.template
          Parameters:
            KeyName: !Ref SSHKey
            DBName: &quot;mydb&quot;
            DBUser: &quot;user&quot;
            DBPassword: &quot;pass&quot;
            DBRootPassword: &quot;passroot&quot;
            InstanceType: t2.micro
            SSHLocation: &quot;0.0.0.0/0&quot;

Outputs:
  StackRef:
    value: !Ref myStack
  OutputFromNestedStack:
    value: !GetAtt mystack.Outputs.WebsiteURL
</code></pre>

<h3 id="change-sets">Change sets</h3>
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html">DOCU</a></p>
</li>
<li>
<p>Sirve para actualizar o subir otra cosa de una stack ya creada y podremos ver el proceso de si se haría bien o no. Si nos interesa, le damos a EXECUTE y empieza a cambiarse, sino DELETE.  </p>
</li>
</ul>
<h3 id="depends-on">Depends on</h3>
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-dependson.html">DOCU</a>  </p>
</li>
<li>
<p>De crear una instancia que depende de otra creada.  </p>
</li>
<li>
<p>Ejemplo:  </p>
</li>
</ul>
<pre><code>AWSTemplateFormatVersion: '2010-09-09'
Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0ff8a91507f77f867
    us-west-1:
      AMI: ami-0bdb828fd58c52235
    eu-west-1:
      AMI: ami-047bb4163c506cd98
    ap-northeast-1:
      AMI: ami-06cd52961ce9f0d85
    ap-southeast-1:
      AMI: ami-08569b978cc4dfa10
Resources:
  Ec2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId:
        Fn::FindInMap:
        - RegionMap
        - Ref: AWS::Region
        - AMI
    DependsOn: myDB
  myDB:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: '5'
      DBInstanceClass: db.t2.small
      Engine: MySQL
      EngineVersion: '5.5'
      MasterUsername: MyName
      MasterUserPassword: MyPassword
</code></pre>

<h3 id="detect-drift-stack">Detect drift stack</h3>
<ul>
<li>
<p>Sirve para hacer marcas y ver donde se cambió si actualizas la template o modificas algo de la template  </p>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/detect-drift-stack.html">DOCU</a></p>
</li>
<li>
<p>Vamos a stack actions - detect drift una vez ya hemos metido nuestra template creada. Podemos ver en view drift y si modificamos cosas como el security groups veremos que la marca cambia.</p>
</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../jenkins/" class="btn btn-neutral float-right" title="Jenkins">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../terraform/" class="btn btn-neutral" title="Terraform"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../terraform/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../jenkins/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
