<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Miguel Amorós">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>LDAP - Miguel's Notes</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "LDAP";
    var mkdocs_page_input_path = "ldap.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Miguel's Notes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">MkDocs</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../linux/">Linux</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../soporte/">Soporte TI</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../vscode/">VSCode</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../gitlab/">Gitlab</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../python/">Python</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../bash_scripting/">BashScripting</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../powershell/">PowerShell/CMD</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../docker/">Docker</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../kubernetes/">Kubernetes</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../openshift/">Openshift</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../terraform/">Terraform</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../aws/">AWS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../jenkins/">Jenkins</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ansible/">Ansible</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../tomcat/">Tomcat</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../elastic/">ELKS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../azure/">Azure</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../office/">Office 365</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../markdown/">Markdown</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../bbdd/">Base de datos</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../sap/">SAP</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">LDAP</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#creacion">CREACION</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ficheros-ldap">FICHEROS LDAP</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#schema">SCHEMA</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#acl">ACL</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#ordenes-ldap">ORDENES LDAP</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../pam/">PAM</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../samba/">SAMBA</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../kerberos/">KERBEROS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../lvm/">LVM/RAID</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../backup/">Backup</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../routing/">Routing</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../files/">Archivos Destacados</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../windows/">Windows</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../taller/">Taller</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Miguel's Notes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>LDAP</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/isx46410800/miguelamoros.github.io/edit/master/docs/ldap.md"> Edit on isx46410800/python</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="ldap">LDAP</h1>
<p><img alt="" src="../images/ldap.png" />  </p>
<ul>
<li>
<p>Administra un servicio de directorios.  </p>
</li>
<li>
<p>Autenticación: demuestra quien soy (auth)</p>
</li>
<li>Autorizar: que derechos tiene (autz)</li>
<li>Information Provider: la info de la cuenta de usuario</li>
<li>
<p>Authenticaction Provider: quien da el password</p>
</li>
<li>
<p>Es una base de datos no relacional:  </p>
<ul>
<li>Jerarquica</li>
<li>Distribuida</li>
<li>Optimizada por las lecturas</li>
<li>Forma de arbol</li>
<li>Trabaja con identidades</li>
</ul>
</li>
<li>
<p>Ejemplo EDT: Escola utiliza LDAP/Kerberos y unix solo utiliza /etc/passwd.</p>
</li>
<li>
<p>Una caja es una entidad y las caracteristicas de la caja son atributos.  </p>
</li>
<li>
<p>Formato ldif para los datos de LDAP</p>
</li>
<li>
<p>Paquetes de instalación: <code>openldap-clients openldap-servers</code></p>
</li>
<li>
<p><code>slapd</code> ordenes de bajo nivel para el servidor</p>
</li>
<li>
<p><code>/var/lib/ldap</code> directorio donde se guarda las bbdd</p>
<blockquote>
<p>ldap.ldap</p>
</blockquote>
</li>
<li>
<p><code>/etc/openldap/slapd.d</code> directorio de condiguración</p>
<blockquote>
<p>formato ldap</p>
</blockquote>
</li>
</ul>
<p><code>rootdn "cn=Manager,dc=edt,dc=org"</code> es el root total de una bbdd.  </p>
<ul>
<li>
<p>Puertos LDAP 389</p>
</li>
<li>
<p>Encender servicio <code>/sbin/slapd -d</code></p>
</li>
</ul>
<h2 id="creacion">CREACION</h2>
<ul>
<li>
<p>Ejemplo <a href="https://github.com/isx46410800/ldapserver19/tree/master/ldapserver19:group">ldap normal</a>  </p>
</li>
<li>
<p>Dockerfile:  </p>
</li>
</ul>
<pre><code># ldapserver
FROM fedora:27
LABEL version=&quot;1.0&quot;
LABEL author=&quot;Miguel Amorós&quot;
LABEL subject=&quot;ldapserver&quot;
RUN dnf install -y openldap-servers openldap-clients
RUN mkdir /opt/docker
COPY * /opt/docker/
RUN chmod +x /opt/docker/startup.sh
WORKDIR /opt/docker
CMD /opt/docker/startup.sh
</code></pre>

<ul>
<li>Install.sh:  </li>
</ul>
<pre><code>#! /bin/bash
# Install ldap server
rm -rf /etc/openldap/slapd.d/*
rm -rf /var/lib/ldap/*
cp /opt/docker/DB_CONFIG /var/lib/ldap/. 
slaptest -f /opt/docker/slapd.conf -F /etc/openldap/slapd.d/
slapadd -F /etc/openldap/slapd.d/ -l /opt/docker/edt.org.ldif
chown -R ldap.ldap /etc/openldap/slapd.d
chown -R ldap.ldap /var/lib/ldap
cp /opt/docker/ldap.conf /etc/openldap/.
</code></pre>

<ul>
<li>Startup.sh:  </li>
</ul>
<pre><code>#! /bin/bash
bash /opt/docker/install.sh
ulimit -n 1024
/sbin/slapd 
a=1
while [ $a -eq 1 ]
do
  a=1   
done
</code></pre>

<h2 id="ficheros-ldap">FICHEROS LDAP</h2>
<ul>
<li>Fichero slapd.conf. A partir de este file generamos el directorio de configuración:  </li>
</ul>
<pre><code>#
# See slapd.conf(5) for details on configuration options.
# This file should NOT be world readable.
#
include     /etc/openldap/schema/corba.schema
include     /etc/openldap/schema/core.schema
include     /etc/openldap/schema/cosine.schema
include     /etc/openldap/schema/duaconf.schema
include     /etc/openldap/schema/dyngroup.schema
include     /etc/openldap/schema/inetorgperson.schema
include     /etc/openldap/schema/java.schema
include     /etc/openldap/schema/misc.schema
include     /etc/openldap/schema/nis.schema
include     /etc/openldap/schema/openldap.schema
include     /etc/openldap/schema/ppolicy.schema
include     /etc/openldap/schema/collective.schema
# Allow LDAPv2 client connections.  This is NOT the default.
allow bind_v2
pidfile     /var/run/openldap/slapd.pid
#argsfile   /var/run/openldap/slapd.args
# ----------------------------------------------------------------------
database mdb
suffix &quot;dc=edt,dc=org&quot;
rootdn &quot;cn=Manager,dc=edt,dc=org&quot;
rootpw secret
directory /var/lib/ldap
index objectClass                       eq,pres
access to * by self write by * read
# ----------------------------------------------------------------------
# ----------------------------------------------------------------------
database config
rootdn &quot;cn=Sysadmin,cn=config&quot;
rootpw {SSHA}5DfZc1WXeIwrP7C3fr23WLZiPZ5YHMgA
# el passwd es syskey
# ----------------------------------------------------------------------
# enable monitoring
database monitor
</code></pre>

<ul>
<li><code>ldap.conf</code> configuración para conectar a ldap:  </li>
</ul>
<pre><code>#
# LDAP Defaults
#
# See ldap.conf(5) for details
# This file should be world readable but not world writable.
#BASE   dc=example,dc=com
#URI    ldap://ldap.example.com ldap://ldap-master.example.com:666
#SIZELIMIT  12
#TIMELIMIT  15
#DEREF      never
TLS_CACERTDIR   /etc/openldap/certs
# Turning this off breaks GSSAPI used with krb5 when rdns = false
SASL_NOCANON    on
URI ldap://ldapserver
BASE dc=edt,dc=org
</code></pre>

<ul>
<li>Fichero <code>edt.org.ldif</code> fichero donde esta el arbol de root, subgrupos,usuarios, grupos:  </li>
</ul>
<pre><code>dn: dc=edt,dc=org
dc: edt
description: Escola del treball de Barcelona
objectClass: dcObject
objectClass: organization
o: edt.org
#
dn: ou=maquines,dc=edt,dc=org
ou: maquines
description: Container per a maquines linux
objectclass: organizationalunit
#
dn: ou=clients,dc=edt,dc=org
ou: clients
description: Container per a clients linux
objectclass: organizationalunit
#
dn: ou=usuaris,dc=edt,dc=org
ou: usuaris
description: Container per usuaris del sistema linux
objectclass: organizationalunit
#
dn: ou=grups,dc=edt,dc=org
ou: grups
description: Container per grups del sistema linux
objectclass: organizationalunit
#
dn: cn=1asix,ou=grups,dc=edt,dc=org
cn: 1asix
gidNumber: 610
description: Grup de 1asix
memberUid: user01
memberUid: user02
memberUid: user03
memberUid: user04
memberUid: user15
objectclass: posixGroup
#
dn: cn=2asix,ou=grups,dc=edt,dc=org
cn: 2asix
gidNumber: 611
description: Grup de 2asix
memberUid: user06
memberUid: user07
memberUid: user08
memberUid: user09
memberUid: user10
objectclass: posixGroup
#
dn: cn=profesasix,ou=grups,dc=edt,dc=org
cn: profesasix
gidNumber: 612
description: Profes de asix
memberUid: pere
memberUid: anna
memberUid: jordi
memberUid: marta
memberUid: pau
objectclass: posixGroup
#
dn: cn=Pau Pou,ou=usuaris,dc=edt,dc=org
objectclass: posixAccount
objectclass: inetOrgPerson
cn: Pau Pou
cn: Pauet Pou
sn: Pou
homephone: 555-222-2220
mail: pau@edt.org
description: Watch out for this guy
ou: Profes
uid: pau
uidNumber: 5000
gidNumber: 612
homeDirectory: /tmp/home/pau
userPassword: {SSHA}NDkipesNQqTFDgGJfyraLz/csZAIlk2/
#
dn: cn=Pere Pou,ou=usuaris,dc=edt,dc=org
objectclass: posixAccount
objectclass: inetOrgPerson
cn: Pere Pou
sn: Pou
homephone: 555-222-2221
mail: pere@edt.org
description: Watch out for this guy
ou: Profes
uid: pere
uidNumber: 5001
gidNumber: 612
homeDirectory: /tmp/home/pere
userPassword: {SSHA}ghmtRL11YtXoUhIP7z6f7nb8RCNadFe+
</code></pre>

<ul>
<li><code>DB_CONFIG</code> configuracion de bbdd:  </li>
</ul>
<pre><code># $OpenLDAP$
# Example DB_CONFIG file for use with slapd(8) BDB/HDB databases.
#
# See the Oracle Berkeley DB documentation
#   &lt;http://www.oracle.com/technology/documentation/berkeley-db/db/ref/env/db_config.html&gt;
# for detail description of DB_CONFIG syntax and semantics.
#
# Hints can also be found in the OpenLDAP Software FAQ
#   &lt;http://www.openldap.org/faq/index.cgi?file=2&gt;
# in particular:
#   &lt;http://www.openldap.org/faq/index.cgi?file=1075&gt;
# Note: most DB_CONFIG settings will take effect only upon rebuilding
# the DB environment.
# one 0.25 GB cache
set_cachesize 0 268435456 1
# Data Directory
#set_data_dir db
# Transaction Log settings
set_lg_regionmax 262144
set_lg_bsize 2097152
#set_lg_dir logs
# Note: special DB_CONFIG flags are no longer needed for &quot;quick&quot;
# slapadd(8) or slapindex(8) access (see their -q option). 
</code></pre>

<h2 id="schema">SCHEMA</h2>
<ul>
<li>Ejemplo de <code>nombre.schema</code>:  </li>
</ul>
<pre><code>attributetype ( 1.1.2.1.1 NAME 'x-equip' 
  DESC 'equip del futbolista'
  EQUALITY caseIgnoreMatch
  SUBSTR caseIgnoreSubstringsMatch
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  SINGLE-VALUE )
attributetype ( 1.1.2.1.2 NAME 'x-dorsal' 
  DESC 'dorsal del futbolista'
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27
  SINGLE-VALUE )
attributetype ( 1.1.2.1.3 NAME 'x-web' 
  DESC 'pagina web del futbolista'
  EQUALITY caseExactMatch
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
attributetype ( 1.1.2.1.4 NAME 'x-foto'  
  DESC 'foto del futbolista'
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )
attributetype ( 1.1.2.1.5 NAME 'x-lesionat'
  DESC 'foto del futbolista'
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.7
  SINGLE-VALUE )
objectclass ( 1.1.2.2.1 NAME 'x-futbolistes' 
  DESC 'futboleros'
  SUP inetOrgPerson
  STRUCTURAL
  MUST x-equip
  MAY ( x-dorsal $ x-web $ x-foto $ x-lesionat ) )
</code></pre>

<ul>
<li>Creacion de un usuario con este schema:  </li>
</ul>
<pre><code>dn: cn=kaka,ou=Productes,dc=edt,dc=org
objectclass: x-futbolistes
cn: kaka
sn: kaka
x-equip: los pimientos
x-dorsal: 7
x-web: www.kaka.com
x-foto: //var/tmp/foto.jpg
x-lesionat: FALSE
</code></pre>

<ul>
<li>Añadimos en el fichero <code>slapd.conf</code> el schema:<br />
<code>include        /opt/docker/futbolista-C.schema</code>  </li>
</ul>
<h2 id="acl">ACL</h2>
<ul>
<li>
<p>En el slapd.conf está el user y pass del ACL.  </p>
</li>
<li>
<p>Ejemplos de ACL, son directrices y permisos que tienen ciertos grupos, usuarios etc:  </p>
</li>
</ul>
<pre><code>Implementar a la base de dades edt.org les següents ACLS:
1. L’usuari “Anna Pou” és ajudant de l’administrador i té permisos per modificar-ho tot.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to * by dn.exact=”cn=Anna Pou,ou=usuaris,dc=edt,dc=org” write by * read [by * none]
[acces to * by * none]
---
**[implicitas aunque no salgan]
[isx46410800@miguel-fedora27 ldapserver19:acl]$ ldapmodify -vx -c -h 172.17.0.2 -D 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -w jordi -f mod01.ldif 
ldap_initialize( ldap://172.17.0.2 )
replace mail:
    newmarta10@edt.org
modifying entry &quot;cn=Marta Mas,ou=usuaris,dc=edt,dc=org&quot;
ldap_modify: Insufficient access (50)

replace mail:
    newmjordi10@edt.org
modifying entry &quot;cn=Jordi Mas,ou=usuaris,dc=edt,dc=org&quot;
modify complete
#
#
2. L’usuari “Anna Pou” és ajudant d’administració. Tothom es pot modificar el seu propi
email i homePhone. Tothom pot veure totes les dades de tothom.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=mail 
 by dn.exact=&quot;cn=Anna Pou,ou=usuaris,dc=edt,dc=org&quot; write
 by self write
 by * read
 [by * none]
olcAccess: to attrs=homePhone 
 by dn.exact=&quot;cn=Anna Pou,ou=usuaris,dc=edt,dc=org&quot; write
 by self write
 by * read
 [by * none]
olcAccess: to * by dn.exact=”cn=Anna Pou,ou=usuaris,dc=edt,dc=org” write by * read [by * none]
[acces to * by * none]
---
#
#
3. Tot usuari es pot modificar el seu mail. Tothom pot veure totes les dades de tothom.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=mail by self write by * read [by * none]
olcAccess: to * by * read [by * none]
[acces to * by * none]
---
#
#
4. Tothom pot veure totes les dades de tothom, excepte els mail dels altres.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=mail by self read [by * none]
olcAccess: to * by * read
[acces to * by * none]
---
[root@ldapserver docker]# ldapsearch -x -LLL -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna dn mail
#
#
5. Tot usuari es pot modificar el seu propi password i tothom pot veure totes les dades de tothom.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=userPassword by self write by * read
olcAccess: to * by * read
---
[root@ldapserver docker]# ldappasswd -x -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna -s anna2
[root@ldapserver docker]# ldapsearch -x -LLL -D 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -w jordi dn userPassword
--
[root@ldapserver docker]# ldappasswd -x -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -s jordi2
Result: Insufficient access (50)
--puedo ver todos los userpassword como ldapsearch -x -LLL
** by auth no es necesario porqie todo el mundo podemos ver el password y no requiere de identificacion
#
6. Tot usuari es pot modificar el seu propi password i tothom pot veure totes les dades de tothom, excepte els altres passwords.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=userPassword by self write by * auth
olcAccess: to * by * read
---
**para que nadie lo vea, puedas cambiarlo, tienes que tener primero permiso de auth para autenticarte primero, sino serias un anonimo de fuera
-----&gt;puedo cambiar pass mio pero no otro
[root@ldapserver docker]# ldappasswd -x -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -s jordi2
Result: Insufficient access (50)
[root@ldapserver docker]# ldappasswd -x -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna -s ann2  
---&gt;no puedo ver los userpassword con ldapsearch -x -LLL ni con [root@ldapserver docker]# ldapsearch -x -LLL -D 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -w jordi dn userPassword
--&gt; solo vere el de jordi por ser authorizado
**sino ponemos el by auth, no podremos autenticarnos ya que al hacer la orden somos un user anonymous y hemos de hacer BIND con el -D para identificarnos y solo se consigue poniendo by auth
--&gt;**
[root@ldapserver docker]# ldapsearch -x -LLL -D 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -w jordi dn userPassword
ldap_bind: Invalid credentials (49)--&gt; no deja sin el by auth
#
#
7. Tot usuari es pot modificar el seu propi password i tot usuari només pot veure les seves pròpies dades.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=userPassword by self write by * auth [by * none]
olcAccess: to * by self read by * search [by * none]
** permet la capacitat de llegir i navegar per tot el arbre
** si ponemos solo by self read, no podremos ver por toodo el contenido para poder ver sus datos y no es capaz de autenticarte.
---
[root@ldapserver docker]# ldappasswd -x -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna -s anna2
[root@ldapserver docker]# ldappasswd -x -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -s jordi2
Result: Insufficient access (50)
--&gt; podemos cambiar nuestro pass pero no el de otro
--&gt;con el by * search tendremos acceso a los campos propios
[root@ldapserver docker]# ldapsearch -x -LLL -D 'cn=Jordi Mas,ou=usuaris,dc=edt,dc=org' -w jordi          
dn: cn=Jordi Mas,ou=usuaris,dc=edt,dc=org
objectClass: posixAccount
**nos permite de todos los usuarios, ver solo el nuestro. en este caso jordi solo ve el suyo
**como anonimo no sale nada porque no tiene datos dentro de la bbdd
#
8. Tot usuari pot observar les seves pròpies dades i modificar el seu propi password,email i homephone. 
L’usuari “Anna Pou” pot modificar tots els atributs de tots excepte els passwords, que tampoc pot veure. 
L’usuari “Pere Pou” pot modificar els passwords de tothom.
---
dn: olcDatabase={1}mdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: to attrs=userPassword 
 by dn.exact=&quot;cn=Pere Pou,ou=usuaris,dc=edt,dc=org&quot; write
 by self write 
 by * auth
 [by * none]
olcAccess: to attrs=mail 
 by dn.exact=&quot;cn=Anna Pou,ou=usuaris,dc=edt,dc=org&quot; write
 by self write
 [by * none]
olcAccess: to attrs=homePhone
 by dn.exact=&quot;cn=Anna Pou,ou=usuaris,dc=edt,dc=org&quot; write
 by self write
 [by * none]
olcAccess: to * 
 by dn.exact=&quot;cn=Anna Pou,ou=usuaris,dc=edt,dc=org&quot; write
 by self read 
 by * search
 [by * none]
---
* by * search para poder ver todas las dades del arbol y hacer match cuando encuentre el suyo que entonces podra ver, el resto no.
</code></pre>

<h2 id="ordenes-ldap">ORDENES LDAP</h2>
<ul>
<li>rm -rf /etc/openldap/slapd.d/*</li>
<li>rm -rf /var/lib/ldap/*</li>
<li>slaptest -F /etc/openldap/slapd.d/ -f /opt/docker/slapd.conf</li>
<li>slapadd -f /etc/openldap/slapd.d -l /opt/docker/usuarios.ldif</li>
<li>/sbin/slapd -d0</li>
<li>slapcat -n0 | grep dn</li>
<li>ldapsearch -x -LLL -h ipLdap -b 'dc=edt,dc=org'</li>
<li>ldapdelete -vx -h IpLDAP -D 'cn=Manager,dc=edt,dc=org' -w secret 'cn=Anna Pou,dc=edt,dc=org'</li>
<li>ldapadd -vx -c -h IpLDAP -D 'cn=Manager,dc=edt,dc=org' -w secret 'cn=Anna Pou,dc=edt,dc=org' -f modificaciones.ldif</li>
<li>ldapmodify -vx -c -h IpLDAP -D 'cn=Manager,dc=edt,dc=org' -w secret 'cn=Anna Pou,dc=edt,dc=org' -f modificaciones.ldif</li>
<li>ldapmodify -vx -c -h IpLDAP -D 'cn=Sysadmin,cn=config' -w syskey 'cn=Anna Pou,dc=edt,dc=org' -f modificaciones.ldif</li>
<li>slappasswd -&gt; genera passwd sha de tipo SHA</li>
<li>slappasswd -h {md5/crypt}</li>
<li>ldapwhoami -x -h IpLDAP -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna</li>
<li>ldappassword -x -h IpLDAP -D 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' -w anna -s annanew</li>
<li>ldapcompare -x -h ipLDAP 'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' homePhone=555-222-222</li>
<li>slapacl -b  'cn=Anna Pou,ou=usuaris,dc=edt,dc=org' 'mail'</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pam/" class="btn btn-neutral float-right" title="PAM">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../sap/" class="btn btn-neutral" title="SAP"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../sap/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../pam/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
